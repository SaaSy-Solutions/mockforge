# MockForge Tunneling Service

MockForge includes a built-in tunneling service that allows you to expose local MockForge servers via public URLs without requiring cloud deployment. This is perfect for:

- **Webhook Testing**: Receive webhooks from external services
- **Team Sharing**: Share local mocks with teammates without deploying
- **Demo/Presentation**: Show mocks to stakeholders without infrastructure setup
- **Integration Testing**: Test integrations that require public endpoints

## Quick Start

### Start a Tunnel

```bash
# Basic tunnel (requires self-hosted tunnel server)
mockforge tunnel start \
  --local-url http://localhost:3000 \
  --server-url https://tunnel.example.com \
  --auth-token your-token

# With custom subdomain
mockforge tunnel start \
  --local-url http://localhost:3000 \
  --subdomain my-api \
  --server-url https://tunnel.example.com

# Using MockForge Cloud (if available)
mockforge tunnel start \
  --local-url http://localhost:3000 \
  --provider cloud \
  --auth-token your-cloud-token
```

### Check Tunnel Status

```bash
mockforge tunnel status --server-url https://tunnel.example.com
```

### Stop a Tunnel

```bash
mockforge tunnel stop --server-url https://tunnel.example.com
```

### List All Tunnels

```bash
mockforge tunnel list --server-url https://tunnel.example.com
```

## Architecture

MockForge tunneling works with a client-server architecture:

1. **Tunnel Server**: A public-facing server that receives requests and forwards them to your local server
2. **Tunnel Client**: Runs locally and maintains a connection to the tunnel server
3. **Public URL**: Generated by the tunnel server (e.g., `https://abc123.tunnel.mockforge.dev`)

```
Internet → Tunnel Server → Tunnel Client → Local MockForge Server
```

## Providers

### Self-Hosted (Recommended)

Run your own tunnel server for complete control and security.

**Setup:**

1. Deploy the MockForge tunnel server (see deployment guide)
2. Configure authentication
3. Use the server URL in tunnel commands

**Example:**

```bash
mockforge tunnel start \
  --local-url http://localhost:3000 \
  --provider self \
  --server-url https://tunnel.yourcompany.com \
  --auth-token $TUNNEL_AUTH_TOKEN
```

### MockForge Cloud (Coming Soon)

Use MockForge's managed tunneling service.

```bash
mockforge tunnel start \
  --local-url http://localhost:3000 \
  --provider cloud \
  --auth-token $MOCKFORGE_CLOUD_TOKEN
```

### Cloudflare Tunnel (Coming Soon)

Use Cloudflare's tunneling service via cloudflared.

```bash
mockforge tunnel start \
  --local-url http://localhost:3000 \
  --provider cloudflare
```

## Integration with `serve` Command

You can automatically start a tunnel when starting MockForge:

```yaml
# config.yaml
server:
  tunnel:
    enabled: true
    provider: self
    server_url: https://tunnel.example.com
    auth_token: ${TUNNEL_AUTH_TOKEN}
    subdomain: my-api  # optional
```

Then start with:

```bash
mockforge serve --config config.yaml
```

The tunnel will automatically start when the server is ready.

## Configuration

### Environment Variables

```bash
# Tunnel server URL
export MOCKFORGE_TUNNEL_SERVER_URL=https://tunnel.example.com

# Authentication token
export MOCKFORGE_TUNNEL_AUTH_TOKEN=your-token-here

# Start tunnel automatically
export MOCKFORGE_TUNNEL_AUTO_START=true
```

### Configuration File

```yaml
# mockforge.yaml
server:
  http:
    port: 3000

  tunnel:
    enabled: true
    provider: self
    server_url: https://tunnel.example.com
    auth_token: ${TUNNEL_AUTH_TOKEN}  # Use env var
    subdomain: my-api                  # Optional
    custom_domain: api.example.com     # Optional (requires provider support)
    websocket_enabled: true
    http2_enabled: true
```

## Features

### WebSocket Support

Tunnels support WebSocket connections for real-time features:

```bash
mockforge tunnel start \
  --local-url http://localhost:3000 \
  --websocket-enabled true
```

### Custom Domains

Some providers support custom domains:

```bash
mockforge tunnel start \
  --local-url http://localhost:3000 \
  --custom-domain api.example.com \
  --provider cloud
```

**Note**: Custom domains require DNS configuration and provider support.

### Subdomain Selection

Request a specific subdomain (availability depends on provider):

```bash
mockforge tunnel start \
  --local-url http://localhost:3000 \
  --subdomain my-unique-api
```

## Use Cases

### 1. Webhook Testing

Expose your local mock server to receive webhooks:

```bash
# Start tunnel
mockforge tunnel start --local-url http://localhost:3000

# Get public URL
# Output: https://abc123.tunnel.example.com

# Configure webhook provider with the public URL
# webhook_url: https://abc123.tunnel.example.com/webhook
```

### 2. Team Sharing

Share a public URL with teammates:

```bash
mockforge tunnel start \
  --local-url http://localhost:3000 \
  --subdomain team-shared-api
```

Teammates can access: `https://team-shared-api.tunnel.example.com`

### 3. CI/CD Testing

Use tunnels in CI/CD for integration testing:

```yaml
# .github/workflows/test.yml
- name: Start MockForge with tunnel
  run: |
    mockforge tunnel start \
      --local-url http://localhost:3000 \
      --server-url ${{ secrets.TUNNEL_SERVER_URL }} \
      --auth-token ${{ secrets.TUNNEL_AUTH_TOKEN }} \
      --subdomain ci-test-${GITHUB_RUN_ID}
```

### 4. Demo/Presentation

Quickly expose mocks for demos:

```bash
mockforge serve --spec demo-api.yaml &
mockforge tunnel start --local-url http://localhost:3000
# Share the public URL with stakeholders
```

## Security Considerations

### Authentication

Always use authentication tokens:

```bash
# Store token securely
export TUNNEL_AUTH_TOKEN=$(cat ~/.tunnel-token)

mockforge tunnel start \
  --local-url http://localhost:3000 \
  --auth-token $TUNNEL_AUTH_TOKEN
```

### HTTPS

Tunnel servers should always use HTTPS:

```bash
mockforge tunnel start \
  --server-url https://tunnel.example.com  # ✅ HTTPS
  # NOT: http://tunnel.example.com        # ❌ Insecure
```

### Network Isolation

For sensitive mocks, consider:
- Using VPN for tunnel server access
- Network-restricted tunnel servers
- IP allowlisting (if supported)

## Troubleshooting

### Connection Failed

**Problem**: Cannot connect to tunnel server

**Solutions**:
1. Verify tunnel server URL is correct
2. Check network connectivity
3. Verify authentication token
4. Check tunnel server logs

```bash
# Test connectivity
curl https://tunnel.example.com/health

# Check tunnel server
mockforge tunnel status --server-url https://tunnel.example.com
```

### Tunnel Not Forwarding Requests

**Problem**: Public URL returns errors or doesn't forward

**Solutions**:
1. Verify local server is running
2. Check local URL is correct
3. Verify tunnel is active: `mockforge tunnel status`
4. Check firewall rules

```bash
# Verify local server
curl http://localhost:3000/health

# Check tunnel status
mockforge tunnel status
```

### Subdomain Not Available

**Problem**: Requested subdomain is already taken

**Solutions**:
1. Try a different subdomain
2. Use auto-generated subdomain (don't specify `--subdomain`)
3. Check if subdomain format is valid

## Best Practices

1. **Use Environment Variables**: Store sensitive tokens in environment variables, not config files
2. **Rotate Tokens**: Regularly rotate authentication tokens
3. **Monitor Usage**: Track tunnel usage and bandwidth
4. **Clean Up**: Stop unused tunnels to free resources
5. **Use HTTPS**: Always use HTTPS for tunnel servers
6. **Network Security**: Restrict tunnel server access if possible

## Comparison with Cloud Deployment

| Feature | Tunneling | Cloud Deployment |
|---------|-----------|------------------|
| **Setup Time** | Seconds | Minutes/Hours |
| **Cost** | Low (self-hosted) | Variable |
| **Control** | Full control | Managed service |
| **Scalability** | Limited by server | Auto-scaling |
| **Persistence** | Temporary | Permanent |
| **Use Case** | Development/Testing | Production |

**Choose tunneling for**:
- Quick testing and development
- Webhook testing
- Temporary sharing
- Demos and presentations

**Choose cloud deployment for**:
- Production workloads
- Long-term availability
- High traffic
- Enterprise requirements

## Self-Hosted Tunnel Server Setup

See `docs/TUNNEL_SERVER_DEPLOYMENT.md` for instructions on deploying your own tunnel server.

## Support

For issues or questions:
- Check troubleshooting section above
- Review tunnel server logs
- Open an issue on GitHub
- Check documentation: `docs/TUNNEL_SERVER_DEPLOYMENT.md`
